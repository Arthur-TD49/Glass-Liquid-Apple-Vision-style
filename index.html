<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Glass Liquid Search ‚Äî Moteur de recherche moderne</title>
<meta name="description" content="Glass Liquid ‚Äî Moteur de recherche elegant avec design Apple Vision" />
<meta name="theme-color" content="#7b6bff" />
<link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Glass Liquid Search%22,%22short_name%22:%22Glass Liquid%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f6f8fb%22,%22theme_color%22:%22%237b6bff%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 192 192%27%3E%3Crect fill=%27%237b6bff%27 width=%27192%27 height=%27192%27/%3E%3Ctext x=%2796%27 y=%27120%27 font-size=%2780%27 fill=%27white%27 text-anchor=%27middle%27 font-weight=%27bold%27%3EGL%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22}]}" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1:#f6f8fb;
    --bg-2:#eef1f6;
    --glass: rgba(255,255,255,0.75);
    --glass-2: rgba(255,255,255,0.85);
    --muted:#334155;
    --accent-1: #7b6bff;
    --accent-2: #00ffd6;
    --radius:18px;
    --card-shadow: 0 10px 30px rgba(16,24,40,0.08);
    --text-primary: #1a202c;
    --text-secondary: #334155;
  }

  html.dark {
    --bg-1:#0f172a;
    --bg-2:#1e293b;
    --glass: rgba(30,41,59,0.75);
    --glass-2: rgba(30,41,59,0.85);
    --muted:#cbd5e1;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text-secondary);background:linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased;transition:background .3s}
  a{color:inherit}
  button{font-family:inherit}

  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px;position:relative;overflow:hidden}

  .bg-blob{
    position:absolute;filter:blur(60px);opacity:0.9;mix-blend-mode:multiply;transform:translate3d(0,0,0);
  }
  .blob-a{width:720px;height:520px;background:radial-gradient(circle at 30% 30%, rgba(123,107,255,0.25), rgba(123,107,255,0.06) 30%, transparent 60%);left:-10%;top:-20%;}
  .blob-b{width:540px;height:420px;background:radial-gradient(circle at 70% 70%, rgba(0,255,214,0.20), rgba(0,255,214,0.04) 30%, transparent 60%);right:-8%;bottom:-10%;}
  @keyframes floaty { 0%{transform:translateY(0px) rotate(0deg)} 50%{transform:translateY(-18px) rotate(0.6deg)} 100%{transform:translateY(0px) rotate(0deg)} }
  .blob-a,.blob-b{animation:floaty 10s ease-in-out infinite;}

  .card {
    position:relative;
    width:min(920px,96vw);
    border-radius:calc(var(--radius)+6px);
    background: linear-gradient(180deg, var(--glass), var(--glass-2));
    border: 1px solid rgba(255,255,255,0.6);
    box-shadow: var(--card-shadow);
    padding:36px;
    display:flex;
    flex-direction:column;
    align-items:center;
    backdrop-filter: blur(8px) saturate(120%);
    transform:translateY(24px);
    opacity:0;
    transition:transform .9s cubic-bezier(.2,.9,.2,1), opacity .9s ease;
  }
  .card.show { transform:translateY(0); opacity:1; }

  .logo {
    width:220px;height:74px;display:flex;align-items:center;justify-content:center;margin-bottom:14px;
    transform:translateY(-6px);opacity:0;transition: transform .9s cubic-bezier(.2,.9,.2,1), opacity .9s;
  }
  .logo.show{ transform:translateY(0); opacity:1; }
  svg.wordmark { width:220px;height:64px; display:block; }
  .subtitle{font-size:14px;color:var(--text-secondary);opacity:0.95;margin-bottom:18px;transform:translateY(-6px);transition:all .9s}

  .search-row{width:100%;display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;position:relative}
  .search-wrapper{flex:1;max-width:720px;position:relative}
  .search-field{
    display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:999px;
    background: rgba(255,255,255,0.9);border:1px solid rgba(16,24,40,0.04);
    box-shadow: 0 6px 24px rgba(10,14,20,0.04);
    transition:box-shadow .18s, transform .18s;
  }
  html.dark .search-field{background:rgba(30,41,59,0.9)}
  .search-field:focus-within{box-shadow:0 18px 60px rgba(123,107,255,0.08);transform:translateY(-2px);}
  .search-field input{flex:1;border:0;background:transparent;outline:0;padding:6px;font-size:17px;color:var(--text-primary)}
  .search-field input::placeholder{color:var(--text-secondary);opacity:0.6}
  .autocomplete-list{
    position:absolute;top:100%;left:0;right:0;margin-top:4px;background:rgba(255,255,255,0.95);border-radius:12px;
    border:1px solid rgba(16,24,40,0.04);box-shadow:0 12px 40px rgba(10,14,20,0.08);
    display:none;z-index:100;max-height:300px;overflow-y:auto;
  }
  html.dark .autocomplete-list{background:rgba(30,41,59,0.95)}
  .autocomplete-list.show{display:block}
  .autocomplete-item{
    padding:12px 16px;cursor:pointer;color:var(--text-secondary);border-bottom:1px solid rgba(16,24,40,0.02);
    transition:background .15s;
  }
  .autocomplete-item:hover{background:rgba(123,107,255,0.08)}
  .autocomplete-item:last-child{border-bottom:none}
  .search-actions{display:flex;gap:8px}

  .btn {
    padding:10px 14px;border-radius:12px;border:0;font-weight:600;cursor:pointer;
    background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;box-shadow:0 8px 30px rgba(16,24,40,0.06);transition:transform .2s, box-shadow .2s;
  }
  .btn:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 12px 40px rgba(123,107,255,0.15); }
  .btn:disabled { opacity:0.6; cursor:not-allowed; }
  .btn.ghost { background:transparent;border:1px solid rgba(16,24,40,0.04);color:var(--text-secondary) }
  .btn.ghost:hover:not(:disabled) { background:rgba(123,107,255,0.05); }
  .btn.icon { padding:8px; background:transparent; color:var(--text-secondary); }
  .btn.icon:hover { background:rgba(123,107,255,0.05); }

  .hint{font-size:13px;color:var(--text-secondary);margin-top:12px;opacity:0.95}

  .results {
    width:100%;margin-top:20px;max-height:600px;overflow-y:auto;display:none;
  }
  .results.show { display:block; }
  .result-item {
    margin-bottom:18px;padding:12px;border-radius:12px;background:rgba(123,107,255,0.04);border:1px solid rgba(123,107,255,0.08);transition:all .2s;
  }
  .result-item:hover { background:rgba(123,107,255,0.08);border-color:rgba(123,107,255,0.15); }
  .result-title {
    font-weight:600;color:var(--accent-1);margin-bottom:4px;cursor:pointer;text-decoration:none;display:block;
  }
  .result-title:hover { text-decoration:underline; }
  .result-url {
    font-size:12px;color:var(--accent-2);margin-bottom:6px;
  }
  .result-desc {
    font-size:14px;color:var(--text-secondary);line-height:1.5;opacity:0.9;
  }
  .loading {
    text-align:center;padding:20px;color:var(--text-secondary);opacity:0.7;
  }
  .spinner {
    display:inline-block;width:16px;height:16px;border:2px solid rgba(123,107,255,0.2);border-top-color:var(--accent-1);border-radius:50%;animation:spin .8s linear infinite;margin-right:8px;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  .footer{display:flex;gap:12px;margin-top:20px;color:var(--text-secondary);font-size:13px;flex-wrap:wrap}
  .footer a{color:var(--text-secondary);text-decoration:none;padding:8px 10px;border-radius:10px;cursor:pointer;}
  .footer a:hover{background:rgba(123,107,255,0.05);}

  .halo { position:absolute; inset:auto; left:50%; transform:translateX(-50%); bottom:28px; width:180px; height:180px;border-radius:50%; background: radial-gradient(circle at 40% 40%, rgba(123,107,255,0.10), rgba(0,255,214,0.06) 35%, transparent 60%); filter:blur(24px); pointer-events:none; opacity:0; transition:opacity .6s; }
  .halo.show{opacity:1}

  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:1000; padding:20px; }
  .modal.show { display:flex; }
  .modal-content { background:var(--bg-1); border-radius:var(--radius); padding:28px; max-width:600px; width:100%; box-shadow:0 20px 60px rgba(16,24,40,0.15); max-height:80vh; overflow-y:auto; color:var(--text-primary); border:1px solid rgba(255,255,255,0.1); }
  .modal-close { float:right; font-size:24px; cursor:pointer; color:var(--text-secondary); background:none; border:none; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; }
  .modal-close:hover { background:rgba(123,107,255,0.05); border-radius:8px; }
  .modal h2 { margin-top:0; color:var(--accent-1); }
  .modal h3 { color:var(--accent-1); margin-top:16px; }
  .modal p { line-height:1.6; color:var(--text-secondary); }
  .modal ul { line-height:1.8; color:var(--text-secondary); }
  .modal li { margin-bottom:8px; }

  .theme-picker{display:flex;gap:8px;margin-bottom:16px}
  .theme-btn{
    padding:10px 14px;border-radius:8px;border:2px solid rgba(123,107,255,0.2);background:transparent;cursor:pointer;
    color:var(--text-secondary);font-weight:600;transition:all .2s;
  }
  .theme-btn.active{border-color:var(--accent-1);background:rgba(123,107,255,0.1);color:var(--accent-1)}

  .history-list{max-height:300px;overflow-y:auto;background:rgba(123,107,255,0.02);border-radius:8px;padding:8px}
  .history-item{
    padding:10px;margin-bottom:6px;background:rgba(255,255,255,0.5);border-radius:6px;display:flex;justify-content:space-between;align-items:center;
    cursor:pointer;transition:all .2s;
  }
  html.dark .history-item{background:rgba(30,41,59,0.5)}
  .history-item:hover{background:rgba(123,107,255,0.1)}
  .history-delete{
    background:none;border:none;color:var(--muted);cursor:pointer;padding:4px 8px;border-radius:4px;
  }
  .history-delete:hover{background:rgba(255,0,0,0.1);color:#ef4444}

  .changelog-item{margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(123,107,255,0.1)}
  .changelog-item:last-child{border-bottom:none}
  .changelog-version{font-weight:600;color:var(--accent-1);margin-bottom:6px;font-size:14px}
  .changelog-date{font-size:12px;opacity:0.7;margin-bottom:8px}
  .changelog-list{font-size:14px;color:var(--text-secondary);line-height:1.6}

  .auth-form{display:flex;flex-direction:column;gap:8px}
  .auth-form input{padding:10px;border-radius:10px;border:1px solid rgba(16,24,40,0.06);background:transparent}
  .auth-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

  @media (max-width:700px){
    .search-field{padding:12px}
    .card{padding:20px}
    .logo{width:170px;height:60px}
    .search-actions { width:100%; flex-direction:column; }
    .btn { width:100%; }
  }

  :focus{outline:none}
  .focusable:focus{box-shadow:0 0 0 4px rgba(123,107,255,0.12)}
</style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="bg-blob blob-a" aria-hidden="true"></div>
    <div class="bg-blob blob-b" aria-hidden="true"></div>

    <main class="card" role="main" aria-labelledby="mainTitle" id="card">
      <div class="logo" id="logo" aria-hidden="false">
        <svg class="wordmark" viewBox="0 0 360 90" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Glass Liquid">
          <defs>
            <linearGradient id="wg" x1="0" x2="1">
              <stop offset="0" stop-color="#7b6bff"/>
              <stop offset="1" stop-color="#00ffd6"/>
            </linearGradient>
            <filter id="soft">
              <feGaussianBlur stdDeviation="6" result="b"/>
              <feBlend in="SourceGraphic" in2="b"/>
            </filter>
          </defs>
          <g fill="none" stroke="url(#wg)" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" filter="url(#soft)">
            <path d="M8 60 C36 20, 120 20, 150 60" stroke-opacity="0.98"/>
            <path d="M164 20 L198 60" stroke-opacity="0.98"/>
            <path d="M220 20 L254 60" stroke-opacity="0.98"/>
            <path d="M276 20 L310 60" stroke-opacity="0.98"/>
          </g>
        </svg>
      </div>

      <div class="subtitle" id="subtitle">Moteur de recherche √©l√©gant et moderne</div>

      <form id="searchForm" class="search-row" role="search" onsubmit="onSubmit(event)" aria-label="Formulaire de recherche">
        <div class="search-wrapper">
          <div class="search-field" role="presentation">
            <button type="button" tabindex="-1" aria-hidden="true">üîç</button>
            <input id="q" name="q" type="search" autocomplete="off" placeholder="Votre recherche..." aria-label="Champ de recherche" />
            <button type="button" class="focusable" onclick="clearQ()" aria-label="Effacer" style="background:none; border:none; cursor:pointer; padding:4px; color:var(--text-secondary); font-size:14px;">‚úñ</button>
          </div>
          <div class="autocomplete-list" id="autocompleteList"></div>
        </div>

        <div class="search-actions" role="group" aria-label="Actions de recherche">
          <button type="submit" class="btn focusable" id="searchBtn">Recherche</button>
          <button type="button" class="btn ghost focusable" onclick="feelingLucky()">Surprise</button>
          <button type="button" class="btn icon focusable" onclick="toggleDarkMode()" title="Basculer le th√®me" style="min-width:auto">üåô</button>
        </div>
      </form>

      <div class="results" id="results"></div>

      <div class="hint">Appuie sur <kbd>/</kbd> pour focus ‚Ä¢ <kbd>Ctrl+K</kbd> raccourci ‚Ä¢ <kbd>Esc</kbd> fermer</div>

      <div class="footer" id="footer"></div>

      <div class="halo" id="halo" aria-hidden="true"></div>
    </main>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
  // --- State & persistence ---
  let isSearching = false;
  let currentTheme = localStorage.getItem('glTheme') || 'light';
  let currentUser = JSON.parse(localStorage.getItem('glCurrentUser') || 'null'); // {email, displayName}
  let searchHistory = [];

  if (currentTheme === 'dark') {
    document.documentElement.classList.add('dark');
  }

  // Initialize history: if user logged in, load their history, otherwise global
  function loadHistoryForCurrentUser() {
    if (currentUser && currentUser.email) {
      searchHistory = JSON.parse(localStorage.getItem('glHistory_' + currentUser.email) || '[]').slice(0,20);
    } else {
      searchHistory = JSON.parse(localStorage.getItem('glSearchHistory') || '[]').slice(0,20);
    }
  }

  loadHistoryForCurrentUser();

  // Update footer to show auth controls
  function updateFooterAuth(){
    const footer = document.getElementById('footer');
    if (currentUser && currentUser.email) {
      footer.innerHTML = `
        <a onclick="openModal('about')">√Ä propos</a>
        <a onclick="openModal('blog')">Blog & FAQ</a>
        <a onclick="openModal('history')">Historique</a>
        <a onclick="openModal('changelog')">Changelog</a>
        <a onclick="openModal('settings')">Param√®tres</a>
        <a onclick=\"openModal('profile')\">üë§ ${escapeHtml(currentUser.displayName || currentUser.email.split('@')[0])}</a>
        <a onclick=\"logout()\">Se d√©connecter</a>
      `;
    } else {
      footer.innerHTML = `
        <a onclick="openModal('about')">√Ä propos</a>
        <a onclick="openModal('blog')">Blog & FAQ</a>
        <a onclick="openModal('history')">Historique</a>
        <a onclick="openModal('changelog')">Changelog</a>
        <a onclick="openModal('settings')">Param√®tres</a>
        <a onclick="openModal('auth','login')">Se connecter</a>
        <a onclick="openModal('auth','signup')">S'inscrire</a>
      `;
    }
  }

  updateFooterAuth();

  window.addEventListener('load', () => {
    requestAnimationFrame(() => {
      document.getElementById('card').classList.add('show');
      document.getElementById('logo').classList.add('show');
      document.getElementById('subtitle').style.transform = 'translateY(0)';
      document.getElementById('subtitle').style.opacity = '1';
      setTimeout(() => document.getElementById('halo').classList.add('show'), 650);
    });
  });

  const qInput = document.getElementById('q');
  
  document.addEventListener('keydown', (e) => {
    if(e.key === '/' && document.activeElement !== qInput && !document.getElementById('modal').classList.contains('show')){
      e.preventDefault();
      qInput.focus();
      qInput.select();
    }
    if((e.key === 'k' && (e.ctrlKey || e.metaKey))) {
      e.preventDefault();
      qInput.focus();
      qInput.select();
    }
    if(e.key === 'Escape') {
      closeModal();
      document.getElementById('autocompleteList').classList.remove('show');
    }
  });

  qInput.addEventListener('input', (e) => {
    const value = e.target.value.trim();
    const list = document.getElementById('autocompleteList');
    
    if (value.length > 0) {
      const suggestions = searchHistory.filter(h => h.toLowerCase().includes(value.toLowerCase())).slice(0, 5);
      if (suggestions.length > 0) {
        list.innerHTML = suggestions.map(s => `<div class="autocomplete-item" onclick="selectSuggestion('${escapeHtml(s)}')">${escapeHtml(s)}</div>`).join('');
        list.classList.add('show');
      } else {
        list.classList.remove('show');
      }
    } else {
      list.classList.remove('show');
    }
  });

  function selectSuggestion(query) {
    qInput.value = query;
    document.getElementById('autocompleteList').classList.remove('show');
    performSearch(query);
  }

  async function performSearch(query) {
    if (!query.trim() || isSearching) return;
    
    isSearching = true;
    const resultsDiv = document.getElementById('results');
    const searchBtn = document.getElementById('searchBtn');
    
    searchBtn.disabled = true;
    resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Recherche en cours...</div>';
    resultsDiv.classList.add('show');

    // Add to history (per-user or global)
    if (!searchHistory.includes(query)) {
      searchHistory.unshift(query);
      searchHistory = searchHistory.slice(0, 20);
      if (currentUser && currentUser.email) {
        localStorage.setItem('glHistory_' + currentUser.email, JSON.stringify(searchHistory));
      } else {
        localStorage.setItem('glSearchHistory', JSON.stringify(searchHistory));
      }
    }

    try {
      const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_redirect=1`);
      const data = await response.json();
      
      let html = '';
      const results = data.RelatedTopics || [];
      const webResults = results.filter(r => r.FirstURL).slice(0, 8);
      
      if (webResults.length === 0) {
        html = '<div class="result-item"><p style="opacity:0.7;">Aucun r√©sultat trouv√© pour "' + escapeHtml(query) + '"</p></div>';
      } else {
        webResults.forEach(result => {
          const title = result.Text.split(' - ')[0] || 'R√©sultat';
          const desc = result.Text || '';
          const url = result.FirstURL;
          
          html += `
            <div class="result-item">
              <a href="${url}" target="_blank" rel="noopener noreferrer" class="result-title">${escapeHtml(title)}</a>
              <div class="result-url">${new URL(url).hostname}</div>
              <div class="result-desc">${escapeHtml(desc.substring(0, 150))}</div>
            </div>
          `;
        });
      }
      
      resultsDiv.innerHTML = html;
    } catch (error) {
      resultsDiv.innerHTML = '<div class="result-item"><p style="opacity:0.7;">Erreur lors de la recherche. V√©rifiez votre connexion.</p></div>';
    }
    
    isSearching = false;
    searchBtn.disabled = false;
  }

  function escapeHtml(text) {
    const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
    return (text + '').replace(/[&<>"']/g, m => map[m]);
  }

  function onSubmit(e){
    e.preventDefault();
    const v = qInput.value.trim();
    if (v) {
      performSearch(v);
      document.getElementById('autocompleteList').classList.remove('show');
      const halo = document.getElementById('halo');
      halo.style.transition = 'opacity .18s, transform .4s';
      halo.style.transform = 'translateY(-8px) scale(1.02)';
      halo.style.opacity = '0.95';
      setTimeout(() => { 
        halo.style.transform = 'translateY(0) scale(1)';
        halo.style.opacity = '0';
      }, 400);
    }
  }

  function clearQ(){ 
    qInput.value = ''; 
    qInput.focus();
    document.getElementById('results').classList.remove('show');
    document.getElementById('autocompleteList').classList.remove('show');
  }

  function feelingLucky(){
    const samples = ['meilleurs caf√©s Paris', 'apprendre JavaScript', 'recette tarte aux pommes', 'tendances design 2025', 'tunisie tourisme'];
    const pick = samples[Math.floor(Math.random()*samples.length)];
    qInput.value = pick;
    setTimeout(() => performSearch(pick), 100);
  }

  function toggleDarkMode() {
    document.documentElement.classList.toggle('dark');
    currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    localStorage.setItem('glTheme', currentTheme);
  }

  // --- Authentication (local, client-side) ---
  // Users are stored in localStorage under key 'glUsers' as an object: { email: {displayName, pwHash, createdAt} }

  async function hashPassword(pw) {
    const enc = new TextEncoder();
    const data = enc.encode(pw);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  }

  function getUsers() {
    return JSON.parse(localStorage.getItem('glUsers') || '{}');
  }

  function saveUsers(users) {
    localStorage.setItem('glUsers', JSON.stringify(users));
  }

  async function signup(email, displayName, password) {
    const users = getUsers();
    if (users[email]) throw new Error('Un compte existe d√©j√† avec cet e-mail.');
    const pwHash = await hashPassword(password);
    users[email] = { displayName: displayName || email.split('@')[0], pwHash, createdAt: new Date().toISOString() };
    saveUsers(users);
    // Auto-login
    currentUser = { email, displayName: users[email].displayName };
    localStorage.setItem('glCurrentUser', JSON.stringify(currentUser));
    // migrate global history to user if any
    const globalHist = JSON.parse(localStorage.getItem('glSearchHistory') || '[]');
    if (globalHist.length) {
      localStorage.setItem('glHistory_' + email, JSON.stringify(globalHist));
      localStorage.removeItem('glSearchHistory');
    }
    loadHistoryForCurrentUser();
    updateFooterAuth();
  }

  async function login(email, password) {
    const users = getUsers();
    const user = users[email];
    if (!user) throw new Error('Utilisateur non trouv√©.');
    const pwHash = await hashPassword(password);
    if (pwHash !== user.pwHash) throw new Error('Mot de passe incorrect.');
    currentUser = { email, displayName: user.displayName };
    localStorage.setItem('glCurrentUser', JSON.stringify(currentUser));
    loadHistoryForCurrentUser();
    updateFooterAuth();
  }

  function logout() {
    currentUser = null;
    localStorage.removeItem('glCurrentUser');
    loadHistoryForCurrentUser();
    updateFooterAuth();
    closeModal();
  }

  // --- Modal content: extend openModal to support auth and profile ---
  function openModal(type, sub) {
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modalBody');
    
    const content = {
      about: `...`,
      blog: `...`,
      history: `...`,
      changelog: `...`,
      settings: `...`,
    };

    // lightweight templates for existing content to keep file compact
    content.about = `
      <h2>√Ä propos de Glass Liquid</h2>
      <p>Glass Liquid est un moteur de recherche moderne con√ßu avec √©l√©gance et performance. Inspir√© par le design Apple Vision, il offre une exp√©rience de recherche fluide et intuitive.</p>
      <h3>Caract√©ristiques</h3>
      <ul>
        <li>üé® Design glassmorphism moderne</li>
        <li>‚ö° Animations fluides et transitions douces</li>
        <li>‚ôø Accessibilit√© compl√®te (WCAG)</li>
        <li>üîç Autocompl√©tion intelligente</li>
        <li>üì± Responsive sur tous les appareils</li>
        <li>üåô Mode sombre automatique</li>
        <li>üì¶ Installation PWA</li>
      </ul>
      <p style="font-size:12px;opacity:0.7;margin-top:16px;">Version 2.0 ‚Äî 2025</p>
    `;

    content.blog = `
      <h2>Blog & FAQ</h2>
      <h3>Comment utiliser Glass Liquid ?</h3>
      <p>Glass Liquid fonctionne comme un moteur de recherche classique. Tapez votre requ√™te et appuyez sur Entr√©e ou cliquez sur "Recherche".</p>
      <h3>Raccourcis clavier</h3>
      <ul>
        <li><strong>/</strong> ‚Äî Focus le champ de recherche</li>
        <li><strong>Ctrl+K</strong> (ou Cmd+K) ‚Äî Focus rapide</li>
        <li><strong>Entr√©e</strong> ‚Äî Lancer la recherche</li>
        <li><strong>Esc</strong> ‚Äî Fermer les modales</li>
      </ul>
    `;

    content.changelog = `
      <h2>Changelog</h2>
      <div class="changelog-item">
        <div class="changelog-version">v2.0 ‚Äî Mise √† jour majeure</div>
        <div class="changelog-date">17 Octobre 2025</div>
        <div class="changelog-list">
          ‚ú® Ajout de l'historique de recherche<br>
          ‚ú® Autocompl√©tion intelligente<br>
          ‚ú® Mode sombre complet<br>
          ‚ú® Support PWA (installer sur l'√©cran d'accueil)<br>
          üé® Nouvelle interface modale raffin√©e<br>
          üêõ Corrections de bugs mineurs
        </div>
      </div>
    `;

    content.history = `
      <h2>Historique de recherche</h2>
      ${searchHistory.length > 0 ? `
        <div class="history-list">
          ${searchHistory.map((item, idx) => `
            <div class="history-item">
              <span onclick="selectSuggestion('${escapeHtml(item)}')" style="cursor:pointer;flex:1">${escapeHtml(item)}</span>
              <button class="history-delete" onclick="deleteHistoryItem(${idx})">üóëÔ∏è</button>
            </div>
          `).join('')}
        </div>
        <button class="btn ghost" onclick="clearHistory()" style="margin-top:12px;width:100%">Vider l'historique</button>
      ` : '<p style="opacity:0.7;">Votre historique est vide.</p>'}
    `;

    content.settings = `
      <h2>Param√®tres</h2>
      <h3>Th√®me</h3>
      <div class="theme-picker">
        <button class="theme-btn ${currentTheme === 'light' ? 'active' : ''}" onclick="setTheme('light')">‚òÄÔ∏è Clair</button>
        <button class="theme-btn ${currentTheme === 'dark' ? 'active' : ''}" onclick="setTheme('dark')">üåô Sombre</button>
      </div>
      <h3>Donn√©es</h3>
      <p>Votre historique de recherche et vos pr√©f√©rences sont stock√©s localement sur votre appareil. Aucune donn√©e n'est envoy√©e √† nos serveurs.</p>
      <button class="btn ghost" onclick="clearAllData()" style="width:100%;margin-top:12px">Effacer toutes les donn√©es</button>
      <h3>Comptes</h3>
      <p>G√©rer les comptes locaux enregistr√©s sur cet appareil.</p>
      <button class="btn ghost" onclick="openModal('auth','manage')" style="width:100%;margin-top:12px">G√©rer les comptes</button>
    `;

    // Auth & profile special handling
    if (type === 'auth') {
      if (sub === 'signup') {
        modalBody.innerHTML = `
          <h2>Cr√©er un compte</h2>
          <form id="signupForm" class="auth-form">
            <input id="su_email" placeholder="E-mail" type="email" required />
            <input id="su_name" placeholder="Nom affich√© (optionnel)" type="text" />
            <input id="su_pw" placeholder="Mot de passe" type="password" required />
            <div class="auth-actions">
              <button type="button" class="btn ghost" onclick="openModal('auth','login')">J'ai d√©j√† un compte</button>
              <button type="button" class="btn" onclick="handleSignup()">S'inscrire</button>
            </div>
            <div style="margin-top:8px;font-size:13px;color:var(--text-secondary);">Les mots de passe sont stock√©s localement sous forme de hachage SHA-256.</div>
          </form>
        `;
      } else if (sub === 'login') {
        modalBody.innerHTML = `
          <h2>Se connecter</h2>
          <form id="loginForm" class="auth-form">
            <input id="li_email" placeholder="E-mail" type="email" required />
            <input id="li_pw" placeholder="Mot de passe" type="password" required />
            <div class="auth-actions">
              <button type="button" class="btn ghost" onclick="openModal('auth','signup')">Cr√©er un compte</button>
              <button type="button" class="btn" onclick="handleLogin()">Connexion</button>
            </div>
          </form>
        `;
      } else if (sub === 'manage') {
        const users = getUsers();
        const list = Object.keys(users).map(e => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(123,107,255,0.02)">
            <div>
              <div style="font-weight:600">${escapeHtml(users[e].displayName || e)}</div>
              <div style="font-size:12px;opacity:0.7">${escapeHtml(e)}</div>
            </div>
            <div>
              <button class="btn ghost" onclick="deleteUser('${encodeURIComponent(e)}')">Supprimer</button>
            </div>
          </div>
        `).join('') || '<p style="opacity:0.7">Aucun compte enregistr√©.</p>';

        modalBody.innerHTML = `
          <h2>Comptes enregistr√©s</h2>
          <div>${list}</div>
          <div style="margin-top:12px;font-size:13px;color:var(--text-secondary);">Supprimer un compte supprimera aussi son historique local.</div>
        `;
      }
      modal.classList.add('show');
      return;
    }

    if (type === 'profile') {
      if (!currentUser) {
        openModal('auth','login');
        return;
      }
      modalBody.innerHTML = `
        <h2>Profil</h2>
        <p><strong>Nom :</strong> ${escapeHtml(currentUser.displayName || '')}</p>
        <p><strong>E-mail :</strong> ${escapeHtml(currentUser.email)}</p>
        <div style="margin-top:12px;display:flex;gap:8px;">
          <button class="btn" onclick="logout()">Se d√©connecter</button>
          <button class="btn ghost" onclick="openModal('auth','manage')">G√©rer comptes</button>
        </div>
      `;
      modal.classList.add('show');
      return;
    }

    modalBody.innerHTML = content[type] || '<h2>Erreur</h2><p>Contenu non disponible.</p>';
    modal.classList.add('show');
  }

  function closeModal() {
    document.getElementById('modal').classList.remove('show');
  }

  function setTheme(theme) {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
    currentTheme = theme;
    localStorage.setItem('glTheme', theme);
    // Refresh modal to show updated theme if open
    const modalBody = document.getElementById('modalBody');
    if (modalBody.innerHTML.includes('theme-picker')) {
      openModal('settings');
    }
  }

  function deleteHistoryItem(index) {
    searchHistory.splice(index, 1);
    if (currentUser && currentUser.email) {
      localStorage.setItem('glHistory_' + currentUser.email, JSON.stringify(searchHistory));
    } else {
      localStorage.setItem('glSearchHistory', JSON.stringify(searchHistory));
    }
    openModal('history');
  }

  function clearHistory() {
    if (confirm('√ätes-vous s√ªr de vouloir effacer votre historique de recherche ?')) {
      searchHistory = [];
      if (currentUser && currentUser.email) {
        localStorage.setItem('glHistory_' + currentUser.email, JSON.stringify(searchHistory));
      } else {
        localStorage.setItem('glSearchHistory', JSON.stringify(searchHistory));
      }
      openModal('history');
    }
  }

  function clearAllData() {
    if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ? Cette action ne peut pas √™tre annul√©e.')) {
      // Remove all app keys but keep users? We'll clear everything for a true reset
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith('gl')) localStorage.removeItem(k);
      });
      currentUser = null;
      loadHistoryForCurrentUser();
      updateFooterAuth();
      openModal('settings');
    }
  }

  // --- Handlers for auth forms ---
  async function handleSignup() {
    const email = document.getElementById('su_email').value.trim().toLowerCase();
    const name = document.getElementById('su_name').value.trim();
    const pw = document.getElementById('su_pw').value;
    try {
      if (!email || !pw) throw new Error('E-mail et mot de passe requis.');
      await signup(email, name, pw);
      alert('Compte cr√©√© et connect√©.');
      closeModal();
    } catch (err) {
      alert(err.message || 'Erreur cr√©ation de compte');
    }
  }

  async function handleLogin() {
    const email = document.getElementById('li_email').value.trim().toLowerCase();
    const pw = document.getElementById('li_pw').value;
    try {
      if (!email || !pw) throw new Error('E-mail et mot de passe requis.');
      await login(email, pw);
      alert('Connect√©.');
      closeModal();
    } catch (err) {
      alert(err.message || 'Erreur connexion');
    }
  }

  // Delete user (and their history)
  function deleteUser(encodedEmail) {
    const email = decodeURIComponent(encodedEmail);
    if (!confirm('Supprimer le compte ' + email + ' ? Cette action supprimera aussi son historique local.')) return;
    const users = getUsers();
    delete users[email];
    saveUsers(users);
    localStorage.removeItem('glHistory_' + email);
    // If deleting current user, log out
    if (currentUser && currentUser.email === email) logout();
    openModal('auth','manage');
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeModal();
    }
  });

  document.getElementById('modal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal')) {
      closeModal();
    }
  });

  // Ensure footer reflects auth state on load
  updateFooterAuth();
</script>
</body>
</html>
